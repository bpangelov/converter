<!DOCTYPE html>
<html>
<body>

<div id="error_div">
    <p id="error_msg"></p>
</div>

Config:<br>
<form id="config">
    <label for="save">Save transformation:</label>
    <input type="checkbox" onclick="saveCheck();" name="save" id="save_check"/><br>
    <label for="config_input">Input type:</label>
    <select id="config_input" name="config_input">
        <option value="json">json</option>
        <option value="yaml">yaml</option>
    </select>
    <label for="config_output">Output type:</label>
    <select id="config_output" name="config_output">
        <option value="json">json</option>
        <option value="yaml">yaml</option>
    </select><br>
    <label for="tabulation">Count of spaces for tabulation:</label>
    <input type="number" id="tabulation" name="quantity" min="1" value="3"><br>
    <label for="property_case">Property case:</label>
    <select id="property_case" name="property_case">
        <option value="snake">snake</option>
        <option value="camel">camel</option>
    </select><br>
    <div id="if_save" style="visibility:hidden">
        <label for="config_name">Name of configuration:</label>
        <input id="config_name"/><br>
        <label for="file_name">Name of file:</label>
        <input id="file_name"/><br>
        <label for="share_with">Share with another user:</label>
        <input id="share_with"/><br>
    </div>
</form>


File:<br>
<textarea id="textarea_input" rows="20" cols="70">
</textarea><br>

<textarea id="textarea_output" rows="20" cols="70">
</textarea><br>

<button type="submit" onclick="submit()">submit</button><br><br>
<button id="update_btn" type="update" onclick="update()" disabled>update</button><br><br>
<button id="delete_btn" type="delete" onclick="" disabled>remove</button><br><br>

History:
<div id="history_div">

</div>

<button type="button" onclick="refreshHistory()">refresh</button><br><br>

Shared:

<div id="shared"></div>

<script>
var API_URL = "http://localhost/converter/api/transformations";

function refreshHistory() {
    resetAll();
    fetch(API_URL)
        .then(response => response.json())
        .then(data => {
            let div = document.getElementById("history_div");
            div.innerHTML = '';
            data.historyEntries.forEach(hist => {
                let anchor = document.createElement('a');
                anchor.href = "#";
                anchor.innerHTML = "config: " + hist.configName + " file: " + hist.fileName;
                anchor.onclick = function() { getTransformation(hist.id) };
                div.appendChild(anchor);
                div.appendChild(document.createElement("br"));
            })
            div = document.getElementById("shared");
            div.innerHTML = '';
            data.sharedEntries.forEach(entry => {
                console.log(entry)
                let anchor = document.createElement('a');
                anchor.href = "#";
                anchor.innerHTML = "config: " + entry.configName + " file: " + entry.fileName;
                anchor.onclick = function() { getTransformation(entry.transformationID) };
                div.appendChild(anchor);
                div.appendChild(document.createElement("br"));
            })
        }).catch(function(err) {
            console.log('Fetch Error :-S', err);
        });
}

function getTransformation(id) {
    fetch(API_URL + "/" + id)
        .then(response => response.json())
        .then(data => {
            document.getElementById("config_name").value = data.config.name;
            document.getElementById("config_input").value = data.config.inputFormat;
            document.getElementById("config_output").value = data.config.outputFormat;
            document.getElementById("tabulation").value = data.config.tabulation;
            document.getElementById("property_case").value = data.config.propertyCase;
            document.getElementById('save_check').checked = true;
            document.getElementById("file_name").value = data.fileName;
            document.getElementById("textarea_input").value = data.originalFile;
            document.getElementById("textarea_output").value = data.convertedFile;
            document.getElementById('if_save').style.visibility = 'visible';
            
            let dlt = document.getElementById("delete_btn");
            dlt.disabled = false;
            dlt.onclick = function() { remove(id) };
            document.getElementById("update_btn").disabled = false;
        }).catch(function(err) {
            console.log('Fetch Error :-S', err);
        });
}

function submit() {
    document.getElementById("textarea_output").value = "";
    dissableModification();
    let apiRequest = {
        "config": {
            "name":         document.getElementById("config_name").value,
            "inputFormat":  document.getElementById("config_input").value,
            "outputFormat": document.getElementById("config_output").value,
            "tabulation":   document.getElementById("tabulation").value,
            "propertyCase": document.getElementById("property_case").value
        },
        "save":             document.getElementById('save_check').checked,
        "fileName":         document.getElementById("file_name").value,
        "inputFileContent": document.getElementById("textarea_input").value,
        "shareWith":        document.getElementById("share_with").value
    };

    fetch(API_URL, {
        method: "POST", 
        body: JSON.stringify(apiRequest),
        headers : { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        return response.json();
    })
    .then(response => {
        document.getElementById("textarea_output").value = response.convertedFile;
    })
    .catch(function(err) {
        console.log('Fetch Error :-S', err);
    });
}

function update() {
    document.getElementById("textarea_output").value = "";
    let apiRequest = {
        "config": {
            "name":         document.getElementById("config_name").value,
            "inputFormat":  document.getElementById("config_input").value,
            "outputFormat": document.getElementById("config_output").value,
            "tabulation":   document.getElementById("tabulation").value,
            "propertyCase": document.getElementById("property_case").value
        },
        "save":             document.getElementById('save_check').checked,
        "fileName":         document.getElementById("file_name").value,
        "inputFileContent": document.getElementById("textarea_input").value,
        "shareWith":        document.getElementById("share_with").value
    };

    fetch(API_URL, {
        method: "PUT", 
        body: JSON.stringify(apiRequest),
        headers : { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        return response.json();
    })
    .then(response => {
        document.getElementById("textarea_output").value = response.convertedFile;
    })
    .catch(function(err) {
        console.log('Fetch Error :-S', err);
    });
}

function saveCheck() {
    if (document.getElementById('save_check').checked) {
        document.getElementById('if_save').style.visibility = 'visible';
    } else {
        document.getElementById('if_save').style.visibility = 'hidden';
        document.getElementById("file_name").value = '';
        document.getElementById("config_name").value = '';
        document.getElementById("share_with").value = '';
    }
}

function remove(id) {
    fetch(API_URL + "/" + id, {
        method: "DELETE", 
    })
    .then(response => {
        resetAll();
        console.log('Item deleted');
        console.log(response);
        response.text();
    })
    .catch(function(err) {
        console.log('Fetch Error :-S', err);
    });
}

function resetAll() {
    document.getElementById("config_input").value = "json";
    document.getElementById("config_output").value = "json";
    document.getElementById("tabulation").value = 3;
    document.getElementById("property_case").value = "camel";
    document.getElementById('save_check').checked = false;
    document.getElementById("textarea_input").value = "";
    document.getElementById("textarea_output").value = "";
    saveCheck();
    dissableModification();
}

function dissableModification() {
    let dlt = document.getElementById("delete_btn");
    dlt.disabled = true;
    dlt.onclick = "";
    document.getElementById("update_btn").disabled = true;
}
</script>

</body>
</html>
