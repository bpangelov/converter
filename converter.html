<!DOCTYPE html>
<html>
<body>

Config:<br>
<form id="config">
    <label for="save">Save transformation:</label>
    <input type="checkbox" onclick="saveCheck();" name="save" id="save_check"/><br>
    <label for="config_input">Input type:</label>
    <select id="config_input" name="config_input">
        <option value="json">json</option>
        <option value="yaml">yaml</option>
    </select>
    <label for="config_output">Output type:</label>
    <select id="config_output" name="config_output">
        <option value="json">json</option>
        <option value="yaml">yaml</option>
    </select><br>
    <label for="tabulation">Count of spaces for tabulation:</label>
    <input type="number" id="tabulation" name="quantity" min="1" value="3"><br>
    <div id="if_save" style="visibility:hidden">
        <label for="config_name">Name of configuration:</label>
        <input id="config_name"/><br>
        <label for="file_name">Name of file:</label>
        <input id="file_name"/><br>
    </div>
</form>


File:<br>
<textarea id="textarea_input" rows="20" cols="70">
</textarea><br>

<textarea id="textarea_output" rows="20" cols="70">
</textarea><br>

<button type="button" onclick="submit()">submit</button><br><br>

History:
<div id="history_div">

</div>

<button type="button" onclick="refreshHistory()">refresh</button><br><br>

Shared:

<div id="shared"></div>

<script>
var API_URL = "http://localhost/converter/api/transformations";

function refreshHistory() {
    fetch(API_URL)
        .then(response => response.json())
        .then(data => {
            let div = document.getElementById("history_div");
            div.innerHTML = '';
            data.historyEntries.forEach(hist => {
                let anchor = document.createElement('a');
                anchor.href = "#";
                anchor.innerHTML = "config: " + hist.configName + " file: " + hist.fileName;
                anchor.onclick = function() { getTransformation(hist.id) };
                div.appendChild(anchor);
                div.appendChild(document.createElement("br"));
            })
            div = document.getElementById("shared");
            div.innerHTML = '';
            data.sharedEntries.forEach(entry => {
                console.log(entry)
                let anchor = document.createElement('a');
                anchor.href = "#";
                anchor.innerHTML = "config: " + entry.configName + " file: " + entry.fileName;
                anchor.onclick = function() { getTransformation(entry.transformationID) };
                div.appendChild(anchor);
                div.appendChild(document.createElement("br"));
            })
        }).catch(function(err) {
            console.log('Fetch Error :-S', err);
        });
}

function getTransformation(id) {
    fetch(API_URL + "/" + id)
        .then(response => response.json())
        .then(data => {
            document.getElementById("config_name").value = data.config.name;
            document.getElementById("config_input").value = data.config.inputFormat;
            document.getElementById("config_output").value = data.config.outputFormat;
            document.getElementById("tabulation").value = data.config.tabulation;
            document.getElementById('save_check').checked = true;
            document.getElementById("file_name").value = data.fileName;
            document.getElementById("textarea_input").value = data.originalFile;
            document.getElementById("textarea_output").value = data.convertedFile;
            document.getElementById('if_save').style.visibility = 'visible';
        }).catch(function(err) {
            console.log('Fetch Error :-S', err);
        });
}

function submit() {
    let apiRequest = {
        "config": {
            "name":        document.getElementById("config_name").value,
            "inputFormat": document.getElementById("config_input").value,
            "outputFormat":document.getElementById("config_output").value,
            "tabulation":  document.getElementById("tabulation").value,
        },
        "save":            document.getElementById('save_check').checked,
        "fileName":        document.getElementById("file_name").value,
        "inputFileContent":document.getElementById("textarea_input").value
    };

    fetch(API_URL, {
        method: "POST", 
        body: JSON.stringify(apiRequest),
        headers : { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        return response.json();
    })
    .then(response => {
        document.getElementById("textarea_output").value = response.convertedFile;
    })
    .catch(function(err) {
        console.log('Fetch Error :-S', err);
    });
}

function saveCheck() {
    if (document.getElementById('save_check').checked) {
        document.getElementById('if_save').style.visibility = 'visible';
    } else {
        document.getElementById('if_save').style.visibility = 'hidden';
        document.getElementById("file_name").value = '';
        document.getElementById("config_name").value = '';
    }
}
</script>

</body>
</html>
